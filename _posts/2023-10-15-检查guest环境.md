---
layout:     post
title:      æ£€æŸ¥guestç¯å¢ƒ
# subtitle:    "\"Hello World, Hello Blog\""
date:       2023-10-15
author:     Underdog Linux
header-img: img/post-bg-2015.jpg
catalog: true
tags:
    - QNX Hypervisor Protection Features
---

hypervisor æä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œå…è®¸guest ç¡®å®šå®ƒæ˜¯å¦åœ¨è™šæ‹ŸåŒ–ç¯å¢ƒä¸­è¿è¡Œï¼Œç‰¹åˆ«æ˜¯ QNX hypervisor ç¯å¢ƒã€‚

# ARM platforms
åœ¨ ARM å¹³å°ä¸Šï¼Œæ£€æŸ¥Flattened Device Tree ï¼ˆFDTï¼‰ ä¸­æè¿°guest ç³»ç»Ÿçš„æ¨¡å‹å±æ€§ã€‚
å¦‚æœä½¿ç”¨ `QVM-v8A` è®¾ç½®æ­¤å±æ€§ï¼Œåˆ™ç³»ç»Ÿæ‰˜ç®¡åœ¨ QNX hypervisor è™šæ‹Ÿæœºä¸­ã€‚

# x86 platforms
å¯¹äº x86 å¹³å°ï¼Œè¯·å‚é˜…ç¡¬ä»¶æ–‡æ¡£ï¼Œäº†è§£guest éœ€è¦æ£€æŸ¥å“ªä¸ª CPUID å¯„å­˜å™¨ä½ï¼Œä»¥äº†è§£å®ƒæ˜¯å¦åœ¨hypervisorä¸­è¿è¡Œï¼Œä»¥åŠéœ€è¦åœ¨å¯„å­˜å™¨ä¸­çš„å“ªä¸ªä½ç½®æŸ¥æ‰¾è™šæ‹Ÿæœº ID å­—ç¬¦ä¸²ã€‚
QNX hypervisor è™šæ‹Ÿæœºçš„ ID å­—ç¬¦ä¸²æ˜¯â€œQNXQVMBSâ€ã€‚

ä»¥ä¸‹æ˜¯ QNX guest å¯èƒ½ç”¨æ¥æ£€æŸ¥å…¶æ˜¯å¦åœ¨ x86 å¹³å°ä¸Šçš„ QNX hypervisor ä¸­è¿è¡Œçš„ C ä»£ç ç¤ºä¾‹ï¼š

```c
#include <stdio.h>
#include <stdint.h>
#include <string.h>
#include <arpa/inet.h>

int cpuid(uint32_t id, uint32_t* regs)
{
    asm volatile ("cpuid"
        : "=a" (regs[0]), "=b" (regs[1]), "=c" (regs[2]), "=d" (regs[3])
        : "a" (id), "c" (0));
   return 0;
}

static const char* const qnxstr = "QNXQVMBS";

int main()
{
    uint32_t regs[4];

    cpuid(1, regs);
    if ((regs[2] & (1 << 31)) == 0) {
        puts("We are not running in a hypervisor");
        return 1;
    }

    cpuid(0x40000000, regs);
    regs[1] = htonl(regs[1]);
    regs[2] = htonl(regs[2]);

    if (memcmp(&regs[1], qnxstr, 4) != 0 || memcmp(&regs[2], qnxstr+4, 4) != 0) {
        puts("This is a hypervisor but not a QNX hypervisor system");
        return 1;
    }

    puts("This is a QNX QVM hypervisor system");

    return 0;
}
```

> è¯‘è€…æ³¨ï¼š
> åœ¨Virtual Box Ubuntuç¯å¢ƒä¸­è¿è¡Œç»“æœå¦‚ä¸‹ï¼š
> 
> ğŸ®./a.out
> This is a hypervisor but not a QNX hypervisor system


# Linux and Android guests
æ‚¨å¯ä»¥åœ¨ x86 ä¸Šä¸º Linux å’Œ Android å®¢æˆ·æœºè°ƒæ•´ä¸Šè¿° C ä»£ç ï¼Œæˆ–è¿è¡Œ `cpuid` å®ç”¨ç¨‹åºã€‚





